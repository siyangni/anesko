# Author summary statistics\noutput$author_summary_stats <- renderUI({\n  # Only render for author queries\n  if (input$query_type != \"author\") {\n    return(NULL)\n  }\n  \n  results <- royalty_results()\n  if (is.null(results) || nrow(results) == 0) {\n    return(NULL)\n  }\n  \n  # Remove the TOTAL row for calculations\n  book_data <- results[results$book_id != \"TOTAL\", ]\n  \n  if (nrow(book_data) == 0) {\n    return(NULL)\n  }\n  \n  # Calculate statistics\n  book_count <- nrow(book_data)\n  total_income <- sum(book_data$royalty_income, na.rm = TRUE)\n  total_sales <- sum(book_data$total_sales, na.rm = TRUE)\n  years <- input$royalty_year_range\n  year_count <- years[2] - years[1] + 1\n  avg_income_per_book <- ifelse(book_count > 0, total_income / book_count, 0)\n  avg_income_per_year <- ifelse(year_count > 0, total_income / year_count, 0)\n  \n  # Find top earning book\n  top_book_info <- \"N/A\"\n  if (book_count > 0) {\n    top_book <- book_data[which.max(book_data$royalty_income), ]\n    top_book_info <- paste0(\n      tags$b(top_book$book_title), \" ($\", sprintf(\"%.2f\", top_book$royalty_income), \")\"\n    )\n  }\n  \n  # Also get the total book count for this author (from the dropdown labels)\n  total_books_for_author <- 0\n  author_label <- input$royalty_author_name\n  if (!is.null(author_label) && author_label != \"\") {\n    # Extract book count from the author label (format: \"Author Name (X book(s))\")\n    label_match <- regmatches(author_label, regexec(\"\\\\((\\\\d+) book\", author_label))\n    if (length(label_match) > 1 && length(label_match[[1]]) > 1) {\n      total_books_for_author <- as.numeric(label_match[[1]][2])\n    }\n  }\n  \n  # Create the summary HTML\n  tagList(\n    tags$div(\n      style = \"display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;\",\n      tags$div(\n        style = \"text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 5px;\",\n        tags$h5(\"Average per Book\", style = \"margin-top: 0; color: #495057;\"),\n        tags$p(paste0(\"$\", sprintf(\"%.2f\", avg_income_per_book)), \n              style = \"font-size: 1.2em; font-weight: bold; color: #0d6efd; margin: 5px 0;\")\n      ),\n      tags$div(\n        style = \"text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 5px;\",\n        tags$h5(\"Average per Year\", style = \"margin-top: 0; color: #495057;\"),\n        tags$p(paste0(\"$\", sprintf(\"%.2f\", avg_income_per_year)), \n              style = \"font-size: 1.2em; font-weight: bold; color: #0d6efd; margin: 5px 0;\")\n      ),\n      tags$div(\n        style = \"text-align: center; padding: 10px; background-color: #f8f9fa; border-radius: 5px;\",\n        tags$h5(\"Top Earning Book\", style = \"margin-top: 0; color: #495057;\"),\n        tags$p(HTML(top_book_info), \n              style = \"font-size: 1.1em; font-weight: bold; color: #0d6efd; margin: 5px 0;\")\n      )\n    ),\n    tags$hr(style = \"margin: 15px 0;\"),\n    tags$p(\n      tags$b(\"Total Royalty Income:\"), \n      paste0(\" $\", sprintf(\"%.2f\", total_income)),\n      \" from \", book_count, \" book\", ifelse(book_count == 1, \"\", \"s\"),\n      if (total_books_for_author > 0 && total_books_for_author != book_count) {\n        paste0(\" (out of \", total_books_for_author, \" total books by this author)\")\n      } else {\n        \"\"\n      },\n      \" over \", year_count, \" year\", ifelse(year_count == 1, \"\", \"s\"),\n      \" (\", years[1], \"â€“\", years[2], \")\",\n      style = \"font-size: 1.1em;\"\n    )\n  )\n})